<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">Upgrade 2.x -&gt; 3.x | Middy.js</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://middy.js.org/docs/upgrade/2-3"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Upgrade 2.x -&gt; 3.x | Middy.js"><meta data-react-helmet="true" name="description" content="Version 3.x of Middy no longer supports Node.js versions 12.x. You are highly encouraged to move to Node.js 16.x."><meta data-react-helmet="true" property="og:description" content="Version 3.x of Middy no longer supports Node.js versions 12.x. You are highly encouraged to move to Node.js 16.x."><link data-react-helmet="true" rel="icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://middy.js.org/docs/upgrade/2-3"><link data-react-helmet="true" rel="alternate" href="https://middy.js.org/docs/upgrade/2-3" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://middy.js.org/docs/upgrade/2-3" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.825b9723.css">
<link rel="preload" href="/assets/js/runtime~main.be53ffbf.js" as="script">
<link rel="preload" href="/assets/js/main.90f78502.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/middy-logo-small.svg" alt="Middy Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/middy-logo-small.svg" alt="Middy Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Middy</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/">Documentation</a><a class="navbar__item navbar__link navbar__link--active" href="/docs/middlewares/intro">Middlewares</a><a class="navbar__item navbar__link navbar__link--active" href="/docs/events/intro">AWS Events</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/middyjs/middy" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="navbar__search" style="margin-left:1em"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/intro-to-middy">Intro to Middy</a><button aria-label="Toggle the collapsible sidebar category &#x27;Intro to Middy&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/middlewares">Middlewares</a><button aria-label="Toggle the collapsible sidebar category &#x27;Middlewares&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/writing-middlewares">Writing Middlewares</a><button aria-label="Toggle the collapsible sidebar category &#x27;Writing Middlewares&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/routers">Routers</a><button aria-label="Toggle the collapsible sidebar category &#x27;Routers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item red"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/docs/category/upgrade">Upgrade</a><button aria-label="Toggle the collapsible sidebar category &#x27;Upgrade&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrade/3-4">4.x (Future)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/upgrade/2-3">Upgrade 2.x -&gt; 3.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrade/1-2">Upgrade 1.x -&gt; 2.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrade/0-1">Upgrade 0.x -&gt; 1.x</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/aws-event-examples">AWS Event Examples</a><button aria-label="Toggle the collapsible sidebar category &#x27;AWS Event Examples&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed red"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/integrations">Integrations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Integrations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/best-practices">Best Practices</a><button aria-label="Toggle the collapsible sidebar category &#x27;Best Practices&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Upgrade 2.x -&gt; 3.x</h1></header><p>Version 3.x of Middy no longer supports Node.js versions 12.x. You are highly encouraged to move to Node.js 16.x.
With the Node.js version change all packages are now ECMAScript Modules along side CommonJS Modules.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="notable-changes">Notable changes<a class="hash-link" href="#notable-changes" title="Direct link to heading">â€‹</a></h2><ul><li>New WebSocket middlewares</li><li>HTTP &amp; WebSocket Routers!</li><li>Better error handling</li><li>Timeout error handling</li><li>Errors now use <code>{ cause }</code> for better context</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="core">Core<a class="hash-link" href="#core" title="Direct link to heading">â€‹</a></h2><ul><li><code>onError</code> middleware stack order reversed to match <code>after</code> <strong>[Breaking Change]</strong><ul><li>If you only use <code>@middy/*</code> middlewares no change should be required</li><li>This change has trickle down effects on middlewares with <code>onError</code> (see below for details)</li><li>If you&#x27;re handling errors yourself here are some things to review:<ul><li>Attach near the end so it is triggered first (likely already done)</li><li>Remove <code>return response</code>, this will short circuit the response and block later middleware from modifying the response</li></ul></li></ul></li><li>lambdaHandler now passes <code>{signal}</code> from <code>AbortController</code> to allow for ending lambda early to handle timeout errors</li><li><code>plugin</code> argument now supports:<ul><li><code>internal</code>: Allow the use of <code>new Proxy()</code> for smarter triggering in advanced use cases.</li><li><code>timeoutEarlyInMillis</code>: When before lambda timeout to trigger early exit. Default <code>5</code></li><li><code>timeoutEarlyResponse</code>: Function to throw a custom error or return a pre-set value. Default <code>() =&gt; { throw new Error(&#x27;Timeout&#x27;) }</code></li></ul></li><li>Added <code>.handler()</code> method to allow easier understanding of the execution cycle</li><li>Deprecate <code>applyMiddleware()</code> and <code>__middlewares</code> <strong>[Breaking Change]</strong></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="util">Util<a class="hash-link" href="#util" title="Direct link to heading">â€‹</a></h2><ul><li><code>getInternal</code> error now includes <code>cause</code> set to an array of Errors</li><li>Catch when <code>X-Ray</code> is applied outside of handler invocation scope</li><li><code>normalizeHttpResponse</code> now takes <code>request</code> and mutates response <strong>[Breaking Change]</strong></li><li><code>getCache</code> will return <code>{}</code> instead of <code>undefined</code> when not found <strong>[Breaking Change]</strong></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="middleware">Middleware<a class="hash-link" href="#middleware" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="cloudwatch-metrics"><a href="/docs/middlewares/cloudwatch-metrics">cloudwatch-metrics</a><a class="hash-link" href="#cloudwatch-metrics" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="do-not-wait-for-empty-event-loop"><a href="/docs/middlewares/do-not-wait-for-empty-event-loop">do-not-wait-for-empty-event-loop</a><a class="hash-link" href="#do-not-wait-for-empty-event-loop" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="error-logger"><a href="/docs/middlewares/error-logger">error-logger</a><a class="hash-link" href="#error-logger" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="event-normalizer"><a href="/docs/middlewares/event-normalizer">event-normalizer</a><a class="hash-link" href="#event-normalizer" title="Direct link to heading">â€‹</a></h3><ul><li>Add support for all missing AWS events</li><li>Refactored for performance improvements</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-content-encoding"><a href="/docs/middlewares/http-content-encoding">http-content-encoding</a><a class="hash-link" href="#http-content-encoding" title="Direct link to heading">â€‹</a></h3><ul><li>[New]<!-- --> Applies <code>brotli</code>, <code>gzip</code>, ands <code>deflate</code> compression to response body</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-content-negotiation"><a href="/docs/middlewares/http-content-negotiation">http-content-negotiation</a><a class="hash-link" href="#http-content-negotiation" title="Direct link to heading">â€‹</a></h3><ul><li>Add in <code>defaultToFirstLanguage</code> to allow fallback to a safe language to use</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-cors"><a href="/docs/middlewares/http-cors">http-cors</a><a class="hash-link" href="#http-cors" title="Direct link to heading">â€‹</a></h3><ul><li><code>onError</code> will not modify response unless error has been handled</li><li>Small refactor for performance improvements</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-error-handler"><a href="/docs/middlewares/http-error-handler">http-error-handler</a><a class="hash-link" href="#http-error-handler" title="Direct link to heading">â€‹</a></h3><ul><li>No longer returns the response to short circuit the middleware stack to allow for easier use now that <code>onError</code> is called in reverse order.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-event-normalizer"><a href="/docs/middlewares/http-event-normalizer">http-event-normalizer</a><a class="hash-link" href="#http-event-normalizer" title="Direct link to heading">â€‹</a></h3><ul><li>Option <code>payloadFormatVersion</code> no longer needed</li><li>Will now throw error if not an http event <strong>[Breaking Change]</strong></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-header-normalizer"><a href="/docs/middlewares/http-header-normalizer">http-header-normalizer</a><a class="hash-link" href="#http-header-normalizer" title="Direct link to heading">â€‹</a></h3><ul><li>Modified so that all headers are set to lowercase when <code>canonical:false</code> <strong>[Breaking Change]</strong></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-json-body-parser"><a href="/docs/middlewares/http-json-body-parser">http-json-body-parser</a><a class="hash-link" href="#http-json-body-parser" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-multipart-body-parser"><a href="/docs/middlewares/http-multipart-body-parser">http-multipart-body-parser</a><a class="hash-link" href="#http-multipart-body-parser" title="Direct link to heading">â€‹</a></h3><ul><li>Change default charset from <code>binary</code>/<code>latin1</code> to <code>utf-8</code>. <strong>[Breaking Change]</strong></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-partial-response"><a href="/docs/middlewares/http-partial-response">http-partial-response</a><a class="hash-link" href="#http-partial-response" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-response-serializer"><a href="/docs/middlewares/http-response-serializer">http-response-serializer</a><a class="hash-link" href="#http-response-serializer" title="Direct link to heading">â€‹</a></h3><ul><li>Renamed <code>default</code> option to <code>defaultContentType</code> to improve maintainability <strong>[Breaking Change]</strong></li><li><code>onError</code> will not modify response unless error has been handled</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-router"><a href="/docs/routers/http-router">http-router</a><a class="hash-link" href="#http-router" title="Direct link to heading">â€‹</a></h3><ul><li>[New]<!-- --> Allow re-routing of events to different handlers</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-security-headers"><a href="/docs/middlewares/http-security-headers">http-security-headers</a><a class="hash-link" href="#http-security-headers" title="Direct link to heading">â€‹</a></h3><ul><li><code>onError</code> will not modify response unless error has been handled</li><li>Complete rewrite of options and inclusion of new HTML only headers <strong>[Breaking Change]</strong></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-urlencode-body-parser"><a href="/docs/middlewares/http-urlencode-body-parser">http-urlencode-body-parser</a><a class="hash-link" href="#http-urlencode-body-parser" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="http-urlencode-path-parser"><a href="/docs/middlewares/http-urlencode-path-parser">http-urlencode-path-parser</a><a class="hash-link" href="#http-urlencode-path-parser" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="input-output-logger"><a href="/docs/middlewares/input-output-logger">input-output-logger</a><a class="hash-link" href="#input-output-logger" title="Direct link to heading">â€‹</a></h3><ul><li>Add in new option to mask instead of omit a path.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="rds-signer"><a href="/docs/middlewares/rds-signer">rds-signer</a><a class="hash-link" href="#rds-signer" title="Direct link to heading">â€‹</a></h3><ul><li>Deprecated <code>setToEnv</code> option due to possible security misuse <strong>[Breaking Change]</strong></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="s3-key-normalizer">s3-key-normalizer<a class="hash-link" href="#s3-key-normalizer" title="Direct link to heading">â€‹</a></h3><ul><li>Deprecated in favour of <a href="/docs/middlewares/event-normalizer"><code>event-normalizer</code></a>, v2.x compatible with v3</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="s3-object-response"><a href="/docs/middlewares/s3-object-response">s3-object-response</a><a class="hash-link" href="#s3-object-response" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="secrets-manager"><a href="/docs/middlewares/secrets-manager">secrets-manager</a><a class="hash-link" href="#secrets-manager" title="Direct link to heading">â€‹</a></h3><ul><li>Deprecated <code>setToEnv</code> option due to possible security misuse <strong>[Breaking Change]</strong></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="service-discovery"><a href="/docs/middlewares/service-discovery">service-discovery</a><a class="hash-link" href="#service-discovery" title="Direct link to heading">â€‹</a></h3><ul><li>[New]<!-- --> Allow easy access to discoveryInstances</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="sqs-json-body-parser">sqs-json-body-parser<a class="hash-link" href="#sqs-json-body-parser" title="Direct link to heading">â€‹</a></h3><ul><li>Deprecated in favour of <a href="/docs/middlewares/event-normalizer"><code>event-normalizer</code></a>, v2.x compatible with v3</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="sqs-partial-batch-failure"><a href="/docs/middlewares/sqs-partial-batch-failure">sqs-partial-batch-failure</a><a class="hash-link" href="#sqs-partial-batch-failure" title="Direct link to heading">â€‹</a></h3><ul><li>Complete rewrite to take advantage of <a href="https://aws.amazon.com/about-aws/whats-new/2021/11/aws-lambda-partial-batch-response-sqs-event-source/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/about-aws/whats-new/2021/11/aws-lambda-partial-batch-response-sqs-event-source/</a>, will no longer throw an error if any message fails <strong>[Breaking Change]</strong></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="ssm"><a href="/docs/middlewares/ssm">ssm</a><a class="hash-link" href="#ssm" title="Direct link to heading">â€‹</a></h3><ul><li>Deprecated <code>setToEnv</code> option <strong>[Breaking Change]</strong></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="sts"><a href="/docs/middlewares/sts">sts</a><a class="hash-link" href="#sts" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="validator"><a href="/docs/middlewares/validator">validator</a><a class="hash-link" href="#validator" title="Direct link to heading">â€‹</a></h3><ul><li>Change where errors are stored, from <code>request.error.details</code> to <code>request.error.cause</code> <strong>[Breaking Change]</strong></li><li>Add new options <code>eventSchema</code>, <code>contextSchema</code>, <code>responseSchema</code>. <code>inputSchema</code> and <code>outputSchema</code> become aliases.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="warmup"><a href="/docs/middlewares/warmup">warmup</a><a class="hash-link" href="#warmup" title="Direct link to heading">â€‹</a></h3><p>No change</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="ws-json-body-parser"><a href="/docs/middlewares/ws-json-body-parser">ws-json-body-parser</a><a class="hash-link" href="#ws-json-body-parser" title="Direct link to heading">â€‹</a></h3><ul><li>[New]<!-- --> Parse body from WebSocket event</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="ws-response"><a href="/docs/middlewares/ws-response">ws-response</a><a class="hash-link" href="#ws-response" title="Direct link to heading">â€‹</a></h3><ul><li>[New]<!-- --> Post responses to WebSocket API Gateway</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="ws-router"><a href="/docs/routers/ws-router">ws-router</a><a class="hash-link" href="#ws-router" title="Direct link to heading">â€‹</a></h3><ul><li>[New]<!-- --> Allow re-routing of events to different handlers</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="notes">Notes<a class="hash-link" href="#notes" title="Direct link to heading">â€‹</a></h2><p>If you still need <code>setToEnv</code> you can do something like so:</p><div class="codeBlockContainer_I0IT language-javascript theme-code-block"><div class="codeBlockContent_wNvx javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">middy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lambdaHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">use</span><span class="token punctuation" style="color:#393A34">(</span><span class="token comment" style="color:#999988;font-style:italic">/*...*/</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getInternal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;NODE_ENV&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NODE_ENV</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NODE_ENV</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/middyjs/middy/tree/main/website/docs/upgrade/2-3.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-06-04T22:49:01.000Z">6/4/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/upgrade/3-4"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">4.x (Future)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/upgrade/1-2"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Upgrade 1.x -&gt; 2.x</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#notable-changes" class="table-of-contents__link toc-highlight">Notable changes</a></li><li><a href="#core" class="table-of-contents__link toc-highlight">Core</a></li><li><a href="#util" class="table-of-contents__link toc-highlight">Util</a></li><li><a href="#middleware" class="table-of-contents__link toc-highlight">Middleware</a><ul><li><a href="#cloudwatch-metrics" class="table-of-contents__link toc-highlight">cloudwatch-metrics</a></li><li><a href="#do-not-wait-for-empty-event-loop" class="table-of-contents__link toc-highlight">do-not-wait-for-empty-event-loop</a></li><li><a href="#error-logger" class="table-of-contents__link toc-highlight">error-logger</a></li><li><a href="#event-normalizer" class="table-of-contents__link toc-highlight">event-normalizer</a></li><li><a href="#http-content-encoding" class="table-of-contents__link toc-highlight">http-content-encoding</a></li><li><a href="#http-content-negotiation" class="table-of-contents__link toc-highlight">http-content-negotiation</a></li><li><a href="#http-cors" class="table-of-contents__link toc-highlight">http-cors</a></li><li><a href="#http-error-handler" class="table-of-contents__link toc-highlight">http-error-handler</a></li><li><a href="#http-event-normalizer" class="table-of-contents__link toc-highlight">http-event-normalizer</a></li><li><a href="#http-header-normalizer" class="table-of-contents__link toc-highlight">http-header-normalizer</a></li><li><a href="#http-json-body-parser" class="table-of-contents__link toc-highlight">http-json-body-parser</a></li><li><a href="#http-multipart-body-parser" class="table-of-contents__link toc-highlight">http-multipart-body-parser</a></li><li><a href="#http-partial-response" class="table-of-contents__link toc-highlight">http-partial-response</a></li><li><a href="#http-response-serializer" class="table-of-contents__link toc-highlight">http-response-serializer</a></li><li><a href="#http-router" class="table-of-contents__link toc-highlight">http-router</a></li><li><a href="#http-security-headers" class="table-of-contents__link toc-highlight">http-security-headers</a></li><li><a href="#http-urlencode-body-parser" class="table-of-contents__link toc-highlight">http-urlencode-body-parser</a></li><li><a href="#http-urlencode-path-parser" class="table-of-contents__link toc-highlight">http-urlencode-path-parser</a></li><li><a href="#input-output-logger" class="table-of-contents__link toc-highlight">input-output-logger</a></li><li><a href="#rds-signer" class="table-of-contents__link toc-highlight">rds-signer</a></li><li><a href="#s3-key-normalizer" class="table-of-contents__link toc-highlight">s3-key-normalizer</a></li><li><a href="#s3-object-response" class="table-of-contents__link toc-highlight">s3-object-response</a></li><li><a href="#secrets-manager" class="table-of-contents__link toc-highlight">secrets-manager</a></li><li><a href="#service-discovery" class="table-of-contents__link toc-highlight">service-discovery</a></li><li><a href="#sqs-json-body-parser" class="table-of-contents__link toc-highlight">sqs-json-body-parser</a></li><li><a href="#sqs-partial-batch-failure" class="table-of-contents__link toc-highlight">sqs-partial-batch-failure</a></li><li><a href="#ssm" class="table-of-contents__link toc-highlight">ssm</a></li><li><a href="#sts" class="table-of-contents__link toc-highlight">sts</a></li><li><a href="#validator" class="table-of-contents__link toc-highlight">validator</a></li><li><a href="#warmup" class="table-of-contents__link toc-highlight">warmup</a></li><li><a href="#ws-json-body-parser" class="table-of-contents__link toc-highlight">ws-json-body-parser</a></li><li><a href="#ws-response" class="table-of-contents__link toc-highlight">ws-response</a></li><li><a href="#ws-router" class="table-of-contents__link toc-highlight">ws-router</a></li></ul></li><li><a href="#notes" class="table-of-contents__link toc-highlight">Notes</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/category/middlewares">Middlewares</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/events/intro">AWS Events</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community &amp; support</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/middy?sort=Newest&amp;uqlId=35052" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitter.im/middyjs/Lobby" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Gitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://www.npmjs.com/package/@middy/core" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>npm<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Middy - Built with Docusaurus. - Icons by feathericons.com</div></div></div></footer></div>
<script src="/assets/js/runtime~main.be53ffbf.js"></script>
<script src="/assets/js/main.90f78502.js"></script>
</body>
</html>